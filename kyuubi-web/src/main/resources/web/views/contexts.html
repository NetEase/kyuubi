<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <titl</title>
    <link rel="shortcut icon" th:href="@{/favicon.ico}" type="image/x-icon">
    <!-- Bootstrap -->
    <link th:href="@{/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/bootstrap/css/bootstrap-theme.css}" rel="stylesheet">
    <link th:href="@{/theme.css}" rel="stylesheet">
    <link th:href="@{/datetime/bootstrap-datetimepicker.min.css}" rel="stylesheet">

    <script th:src="@{/common.js}"></script>
    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
    <script th:src="@{/jquery-3.5.1.min.js}"></script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script th:src="@{/bootstrap/js/bootstrap.min.js}"></script>
    <script th:src="@{/bootstrap-notify.min.js}"></script>
    <script th:src="@{/datetime/moment.min.js}"></script>
    <script th:src="@{/datetime/bootstrap-datetimepicker.min.js}"></script>
    <!--    <link th:src="@{/select/bootstrap-select.min.css}" rel="stylesheet">-->
    <!--    <script th:src="@{/select/bootstrap-select.min.js}"></script>-->
</head>
<body>
<style>
    label {
        width: 100px;
        text-align: center;
    }
</style>
<script type="text/javascript" th:inline="javascript">
    /*<![CDATA[*/
    ctxPath = /*[[${#httpServletRequest.getScheme() + "://" + #httpServletRequest.getServerName() + ":" + #httpServletRequest.getServerPort() + #httpServletRequest.getContextPath()}]]*/ '';
    /*]]>*/
</script>

<!-- Fixed navbar -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <a class="navbar-brand navbar-left" style="padding:5px">
        <img th:src="@{/logo.png}" style="display:inline-block;height: 100%;"/>
        Kyuubi
    </a>
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a th:href="@{/rest/index}">Home</a></li>
                <li class="active"><a th:href="@{/rest/contexts}">Contexts</a></li>
                <li><a th:href="@{/rest/sessions}">Sessions</a></li>
                <li><a th:href="@{/rest/statements}">Statements</a></li>
                <li><a th:href="@{/rest/queues}">Queues</a></li>
                <li><a th:href="@{/rest/envs}">Envs</a></li>
                <!--                <li><a href="#history">History</a></li>-->
<!--                <li><a th:href="@{/rest/metrics/metrics(pretty=true)}" target="_blank">Metrics</a></li>-->
            </ul>
            <div class="nav navbar-nav navbar-right">
                <button class="btn btn-inverse" style="margin-top: 10px" onclick="logout()"><strong>Logout</strong>
                </button>
            </div>
        </div><!--/.nav-collapse -->
    </div>
</nav>

<div class="container theme-showcase" role="main">

    <div class="container">
        <form class="form-inline" role="form" id="myForm">
            <div class="form-group">
                <label for="serverLocation">Server位置</label>
                <input type="text" class="form-control" id="serverLocation" name="serverLocation"
                       th:value="${param.serverLocation}">
            </div>
            <div class="form-group">
                <label for="contextId">ApplicationId</label>
                <input type="text" class="form-control" id="contextId" name="contextId" th:value="${param.contextId}">
            </div>
            <div class="form-group">
                <label for="owner">用户</label>
                <input type="text" class="form-control" id="owner" name="owner" th:value="${param.owner}">
            </div>
            <div class="form-group">
                <label for="state">状态</label>
                <select class="form-control" id="state" style="width: 196px" name="state">
                    <option></option>
                    <option value="started" th:selected="${param.state != null} ? ${param.state[0]=='started'} : false">
                        started
                    </option>
                    <option value="stopped" th:selected="${param.state != null} ? ${param.state[0]=='stopped'} : false">
                        stopped
                    </option>
                    <option value="error" th:selected="${param.state != null} ? ${param.state[0]=='error'} : false">
                        error
                    </option>
                    <option value="killed" th:selected="${param.state != null} ? ${param.state[0]=='killed'} : false">
                        killed
                    </option>
                    <option value="shutting_down"
                            th:selected="${param.state != null} ? ${param.state[0]=='shutting_down'} : false">
                        shutting_down
                    </option>
                </select>
            </div>
            <div class="form-group">
                <label for="startTime">开始时间 &gt;=</label>
                <div class="input-group date">
                    <input type='text' class="form-control" id="startTime" name="startTime"
                           th:value="${param.startTime}"/>
                    <!--                    <span class="input-group-addon">-->
                    <!--                        <span class="glyphicon glyphicon-calendar"></span>-->
                    <!--                    </span>-->
                </div>

            </div>
            <div class="form-group">
                <label for="finishTime">开始时间&lt;</label>
                <div class="input-group date">
                    <input type='text' class="form-control" id="finishTime" name="finishTime"
                           th:value="${param.finishTime}"/>
                    <!--                <span class="input-group-addon">-->
                    <!--                        <span class="glyphicon glyphicon-calendar"></span>-->
                    <!--                    </span>-->
                </div>
            </div>
            <button type="submit" class="btn btn-default">提交</button>
            <button type="button" class="btn btn-default" id="resetButton">重置</button>
        </form>
    </div>
    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div>
        <table class="table">
            <thead>
            <tr>
                <th>ApplicationId</th>
                <th style="width: 50px">作业名</th>
                <th>用户</th>
                <th>状态</th>
                <th>队列</th>
                <th>Executor<br/>Num</th>
                <th>Executor<br/>VCores</th>
                <th>Executor<br/>Memory</th>
                <th>kyuubi位置</th>
                <th>开始时间</th>
                <th>结束时间</th>
                <th>Links</th>
            </tr>
            </thead>
            <tr th:each="context : ${contexts}">
                <td th:text="${context.id}">
                </td>
                <td th:text="${context.name}"></td>
                <td th:text="${context.owner}"></td>
                <td th:text="${context.state}"></td>
                <td th:text="${context.queue}"></td>
                <td>
                    <div th:switch="${context.executors}">
                        <span th:case="-1">dynamic</span>
                        <span th:case="*"  th:text="${context.executors}">0</span>
                    </div>
                </td>
                <td th:text="${context.executor_vcores}"></td>
                <td th:text="${context.executor_memory}"></td>
                <td th:text="${context.serverLocation}"></td>
                <td th:text="${context.start_time}"></td>
                <td th:text="${context.finish_time}"></td>
                <td>
                    <a class="btn btn-default btn-xs" target="_blank"
                       th:href="${yarnUrl} + '/cluster/app/' + ${context.id}">Yarn</a>
                    <a class="btn btn-default btn-xs" target="_blank"
                       th:if="${context.state == 'started'}"
                       th:href="${yarnUrl} + '/proxy/' + ${context.id}">Spark</a>

                    <a class="btn btn-default btn-xs" th:href="@{/rest/sessions(contextId=${context.id})}">Session</a>
                    <a class="btn btn-default btn-xs" th:href="@{/rest/statements(contextId=${context.id})}">Sql</a>
                    <button id="killButton" class="btn btn-danger btn-xs"
                            th:if="(${isAdmin}) and (${context.state eq 'started'} or  ${context.state eq 'starting'})"
                            th:href="@{/rest/statements(contextId=${context.id})}" th:attr="context-id=${context.id}">
                        Kill App
                    </button>
                </td>
            </tr>
        </table>
        <div class="pull-right" id="paginator">
            <ul class="pagination">
                <li><a href="javascript:void(0)" th:attr="jump=1">First</a></li>
                <li><a href="javascript:void(0)" th:attr="jump=(${pageIndex} - 1)">Pre</a></li>
                <li class="disabled"><a href="javascript:void(0)" th:text="${pageIndex}"></a></li>
                <li><a href="javascript:void(0)" th:attr="jump=(${pageIndex} + 1)">Next</a></li>
                <li><a href="javascript:void(0)" th:attr="jump=${totalPage}">Last</a></li>
            </ul>
        </div>
    </div>

    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">提示</h4>
                </div>
                <div class="modal-body">确认杀死该作业吗？</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="ensure-button">确认</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>

    <div class="modal fade" id="loadingModal" backdrop="static" keyboard="false" aria-hidden="true"
         data-backdrop="static">
        　　
        <div style="width: 200px;height:20px; z-index: 20000; position: absolute; text-align: center; left: 50%; top: 50%;margin-left:-100px;margin-top:-10px">
            <!--        　　　　<div class="progress progress-striped active" style="margin-bottom: 0;">-->
            <!--        　　　　　　<div class="progress-bar" style="width: 100%;"></div>-->
            <!--        　　　　</div>-->

            <div class="loader"></div>
        </div>
    </div>

</div>
<script>
    var pgx = new Object();
    $(function () {
        $('#startTime').datetimepicker({
            format: 'YYYY-MM-DD HH:mm:ss'
        });
        $('#finishTime').datetimepicker({
            format: 'YYYY-MM-DD HH:mm:ss'
        });
        $('#resetButton').on('click', function () {
            $('input, textarea').val('');
            $('select').find('option').prop("selected", false);
        });
    });


    $("button[context-id]").on("click", function () {
        var contextId = $(this).attr("context-id")
        pgx.contextId = contextId;
        $('#myModal').modal('show');
    });
    $("a[jump]").on("click", function () {
        var page = $(this).attr("jump");
        var url = new URL(window.location.href);
        var search_params = url.searchParams;
        search_params.set('pageIndex', page);
        window.location.href = url.toString();
    });

    $("#ensure-button").on("click", function () {
        $('#myModal').modal('hide');
        $('#loadingModal').modal('show');
        $.ajax({
            url: ctxPath + '/rest/contexts/kill',
            type: 'POST',
            data: {id: pgx.contextId},
            dataType: 'json',
            success: function (data) {
                $('#loadingModal').modal('hide');
                if (data.code === 0) {
                    $.notify({
                        message: "操作成功"
                    }, {
                        'type': 'success',
                        onShown: function () {
                            location.reload();
                        }
                    });
                } else {
                    $.notify({
                        message: "操作失败"
                    }, {
                        'type': 'danger'
                    });
                }
            },
            error: function () {
                $('#loadingModal').modal('hide');
                $.notify({
                    message: "操作失败，服务器异常"
                }, {
                    'type': 'danger'
                });
            }
        })
    })
</script>
</body>
</html>