<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>Kyuubi</title>
    <link rel="shortcut icon" th:href="@{/favicon.ico}" type="image/x-icon">
    <!-- Bootstrap -->
    <link th:href="@{/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/bootstrap/css/bootstrap-theme.css}" rel="stylesheet">
    <link th:href="@{/theme.css}" rel="stylesheet">
    <link th:href="@{/datetime/bootstrap-datetimepicker.min.css}" rel="stylesheet">

    <script th:src="@{/common.js}"></script>
    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
    <script th:src="@{/jquery-3.5.1.min.js}"></script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script th:src="@{/bootstrap/js/bootstrap.min.js}"></script>
    <script th:src="@{/datetime/moment.min.js}"></script>
    <script th:src="@{/datetime/bootstrap-datetimepicker.min.js}"></script>
</head>
<body>
<style>
    label {
        width: 100px;
        text-align: center;
    }
</style>
<script type="text/javascript" th:inline="javascript">
    /*<![CDATA[*/
    ctxPath = /*[[${#httpServletRequest.getScheme() + "://" + #httpServletRequest.getServerName() + ":" + #httpServletRequest.getServerPort() + #httpServletRequest.getContextPath()}]]*/ '';
    /*]]>*/
</script>

<!-- Fixed navbar -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <a class="navbar-brand navbar-left" style="padding:5px">
        <img th:src="@{/logo.png}" style="display:inline-block;height: 100%;"/>
        Kyuubi
    </a>
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a th:href="@{/rest/index}">Home</a></li>
                <li><a th:href="@{/rest/contexts}">Contexts</a></li>
                <li class="active"><a th:href="@{/rest/sessions}">Sessions</a></li>
                <li><a th:href="@{/rest/statements}">Statements</a></li>
                <li><a th:href="@{/rest/queues}">Queues</a></li>
                <li><a th:href="@{/rest/envs}">Envs</a></li>
                <!--                <li><a href="#history">History</a></li>-->
<!--                <li><a th:href="@{/rest/metrics/metrics(pretty=true)}" target="_blank">Metrics</a></li>-->
            </ul>
            <div class="nav navbar-nav navbar-right">
                <button class="btn btn-inverse" style="margin-top: 10px" onclick="logout()"><strong>Logout</strong>
                </button>
            </div>
        </div><!--/.nav-collapse -->
    </div>
</nav>

<div class="container theme-showcase" role="main">

    <div>
        <form class="form-inline" role="form">
            <div class="form-group">
                <label for="serverLocation">Kyuubi位置</label>
                <input type="text" class="form-control" id="serverLocation" name="serverLocation"
                       th:value="${param.serverLocation}">
            </div>
            <div class="form-group">
                <label for="contextId">ApplicationId</label>
                <input type="text" class="form-control" id="contextId" name="contextId" th:value="${param.contextId}">
            </div>
            <div class="form-group" style="display: none">
                <label for="contextId">SessionId</label>
                <input type="text" class="form-control" id="sessionId" name="sessionId" th:value="${param.sessionId}">
            </div>
            <div class="form-group">
                <label for="owner">用户</label>
                <input type="text" class="form-control" id="owner" name="owner" th:value="${param.owner}">
            </div>
            <div class="form-group">
                <label for="state">状态</label>
                <select class="form-control" id="state" style="width: 196px" name="state">
                    <option></option>
                    <option value="started" th:selected="${param.state != null} ? ${param.state[0]=='started'} : false">
                        started
                    </option>
                    <option value="stopped" th:selected="${param.state != null} ? ${param.state[0]=='stopped'} : false">
                        stopped
                    </option>
                    <option value="error" th:selected="${param.state != null} ? ${param.state[0]=='error'} : false">
                        error
                    </option>
                    <option value="killed" th:selected="${param.state != null} ? ${param.state[0]=='killed'} : false">
                        killed
                    </option>
                    <option value="shutting_down"
                            th:selected="${param.state != null} ? ${param.state[0]=='shutting_down'} : false">
                        shutting_down
                    </option>
                </select>
            </div>
            <div class="form-group">
                <label for="startTime">开始时间 &gt;=</label>
                <div class="input-group date">
                    <input type='text' class="form-control" id="startTime" name="startTime"
                           th:value="${param.startTime}"/>
                    <!--                    <span class="input-group-addon">-->
                    <!--                        <span class="glyphicon glyphicon-calendar"></span>-->
                    <!--                    </span>-->
                </div>

            </div>
            <div class="form-group">
                <label for="finishTime">开始时间&lt;</label>
                <div class="input-group date">
                    <input type='text' class="form-control" id="finishTime" name="finishTime"
                           th:value="${param.finishTime}"/>
                    <!--                <span class="input-group-addon">-->
                    <!--                        <span class="glyphicon glyphicon-calendar"></span>-->
                    <!--                    </span>-->
                </div>
            </div>
            <button type="submit" class="btn btn-default">提交</button>
            <button type="button" class="btn btn-default" id="resetButton">重置</button>
        </form>
    </div>
    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div>
        <table class="table">
            <thead>
            <tr>
                <th>ApplicationId</th>
<!--                <th>SessionId</th>-->
                <th>用户</th>
                <th>状态</th>
                <th>Kyuubi位置</th>
                <th>Running SQL</th>
                <th>Error SQL</th>
                <th>Total SQL</th>
                <th>开始时间</th>
                <th>结束时间</th>
                <th>Links</th>
            </tr>
            </thead>
            <tr th:each="ksession : ${spark_sessions}">
                <td>
                    <a th:text="${ksession.contextId}" th:href="@{/rest/contexts(contextId=${ksession.contextId})}"></a>
                </td>
<!--                <td th:text="${ksession.id}">=</td>-->
                <td th:text="${ksession.owner}"></td>
                <td th:text="${ksession.state}"></td>
                <td th:text="${ksession.serverLocation}"></td>
                <td th:text="${ksession.running_sql}"></td>
                <td th:text="${ksession.error_sql}"></td>
                <td th:text="${ksession.total_sql}"></td>
                <td th:text="${ksession.start_time}"></td>
                <td th:text="${ksession.finish_time}"></td>
                <td>
                    <a class="btn btn-default btn-xs" th:href="@{/rest/statements(sessionId=${ksession.id})}">Sql</a>
                    <a class="btn btn-default btn-xs" target="_blank"
                       th:if="${ksession.state == 'started'}"
                       th:href="${yarnUrl} + '/proxy/' + ${ksession.contextId} + '/' + ${ksession.contextId}
                       + '/session?id=' + ${ksession.id}">Spark</a>
                </td>
            </tr>
        </table>
        <div class="pull-right" id="paginator">
            <ul class="pagination">
                <li><a href="javascript:void(0)" th:attr="jump=1">First</a></li>
                <li><a href="javascript:void(0)" th:attr="jump=(${pageIndex} - 1)">Pre</a></li>
                <li class="disabled"><a href="javascript:void(0)" th:text="${pageIndex}"></a></li>
                <li><a href="javascript:void(0)" th:attr="jump=(${pageIndex} + 1)">Next</a></li>
                <li><a href="javascript:void(0)" th:attr="jump=${totalPage}">Last</a></li>
            </ul>
        </div>
    </div>
</div>
<script>
    $(function () {
        $('#startTime').datetimepicker({
            format: 'YYYY-MM-DD HH:mm:ss'
        });
        $('#finishTime').datetimepicker({
            format: 'YYYY-MM-DD HH:mm:ss'
        });
        $('#resetButton').on('click', function () {
            $('input, textarea').val('');
            $('select').find('option').prop("selected", false);
        });
        $("a[jump]").on("click", function () {
            var page = $(this).attr("jump");
            var url = new URL(window.location.href);
            var search_params = url.searchParams;
            search_params.set('pageIndex', page);
            window.location.href = url.toString();
        });
    });
</script>
</body>
</html>